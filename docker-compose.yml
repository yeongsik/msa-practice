# Docker Compose 파일
# 최신 Docker Compose는 version 필드가 필요 없음 (자동 감지)

# 서비스 정의: 각 서비스는 독립적인 컨테이너로 실행됨
services:

  # ============================================
  # User Service용 MySQL 데이터베이스
  # ============================================
  user-mysql:
    # 사용할 Docker 이미지 (MySQL 8.0 LTS 버전)
    image: mysql:8.0

    # 컨테이너 이름 (docker ps로 볼 때 표시되는 이름)
    container_name: user-mysql

    # 재시작 정책: 컨테이너가 중단되면 항상 자동으로 재시작
    # always: Docker 데몬이 시작될 때마다 컨테이너 자동 시작
    restart: always

    # 포트 매핑: "호스트포트:컨테이너포트"
    # 로컬 3306 포트로 접속하면 컨테이너의 3306 포트로 연결됨
    ports:
      - "3306:3306"

    # 환경변수 설정
    # 실제 값은 .env 파일에서 로드됨
    environment:
      # MySQL root 계정 비밀번호 (필수)
      MYSQL_ROOT_PASSWORD: ${USER_MYSQL_ROOT_PASSWORD}

      # 컨테이너 시작 시 자동으로 생성될 데이터베이스 이름
      MYSQL_DATABASE: ${USER_MYSQL_DATABASE}

      # MySQL 문자셋 설정 (한글 지원)
      MYSQL_CHARSET: ${MYSQL_CHARSET}
      MYSQL_COLLATION: ${MYSQL_COLLATION}

    # 볼륨 마운트: 데이터 영속성 보장
    # 컨테이너가 삭제되어도 데이터는 호스트에 보관됨
    volumes:
      # "볼륨이름:컨테이너내부경로"
      # MySQL의 모든 데이터는 /var/lib/mysql에 저장됨
      - user-mysql-data:/var/lib/mysql

      # 초기화 SQL 스크립트 (선택사항)
      # 컨테이너 최초 실행 시 자동으로 실행됨
      # - ./init-scripts/user-service-init.sql:/docker-entrypoint-initdb.d/init.sql

    # 컨테이너 헬스체크: MySQL이 정상 작동하는지 주기적으로 확인
    healthcheck:
      # mysqladmin ping으로 MySQL 서버 응답 확인
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot"]
      interval: 10s       # 10초마다 체크
      timeout: 5s         # 5초 안에 응답 없으면 실패
      retries: 5          # 5번 실패하면 unhealthy 상태
      start_period: 30s   # 시작 후 30초는 헬스체크 실패해도 무시

    # 네트워크 설정
    networks:
      - msa-network

  # ============================================
  # Board Service용 MySQL 데이터베이스
  # ============================================
  board-mysql:
    image: mysql:8.0
    container_name: board-mysql
    restart: always

    # 다른 포트로 매핑 (3307 -> 3306)
    # 이렇게 하면 로컬에서 두 MySQL을 동시에 사용 가능
    # user-mysql: localhost:3306
    # board-mysql: localhost:3307
    ports:
      - "3307:3306"

    # 환경변수 설정
    # 실제 값은 .env 파일에서 로드됨
    environment:
      MYSQL_ROOT_PASSWORD: ${BOARD_MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${BOARD_MYSQL_DATABASE}
      MYSQL_CHARSET: ${MYSQL_CHARSET}
      MYSQL_COLLATION: ${MYSQL_COLLATION}

    volumes:
      # user-mysql과 다른 볼륨 사용 (완전히 독립적)
      - board-mysql-data:/var/lib/mysql

    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    networks:
      - msa-network

  # ============================================
  # Discovery Service (Eureka Server)
  # ============================================
  discovery-service:
    build:
      context: .
      dockerfile: discovery-service/Dockerfile
    container_name: discovery-service
    ports:
      - "8761:8761"
    networks:
      - msa-network
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Gateway Service
  # ============================================
  gateway-service:
    build:
      context: .
      dockerfile: gateway-service/Dockerfile
    container_name: gateway-service
    ports:
      - "8000:8000"
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
    depends_on:
      discovery-service:
        condition: service_healthy
    networks:
      - msa-network

  # ============================================
  # User Service
  # ============================================
  user-service:
    build:
      context: .
      dockerfile: user-service/Dockerfile
    container_name: user-service
    ports:
      - "8080:8080"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://user-mysql:3306/userdb?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul&characterEncoding=UTF-8
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${USER_MYSQL_ROOT_PASSWORD}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
    depends_on:
      discovery-service:
        condition: service_healthy
      user-mysql:
        condition: service_healthy
    networks:
      - msa-network

  # ============================================
  # Board Service
  # ============================================
  board-service:
    build:
      context: .
      dockerfile: board-service/Dockerfile
    container_name: board-service
    ports:
      - "8081:8081"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://board-mysql:3306/boarddb?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul&characterEncoding=UTF-8
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${BOARD_MYSQL_ROOT_PASSWORD}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
    depends_on:
      discovery-service:
        condition: service_healthy
      board-mysql:
        condition: service_healthy
    networks:
      - msa-network

# ============================================
# 볼륨 정의: 데이터 영속성 보장
# ============================================
volumes:
  # User Service MySQL 데이터 볼륨
  # Docker가 관리하는 Named Volume
  # 실제 위치: /var/lib/docker/volumes/msa-practice_user-mysql-data/_data
  user-mysql-data:
    driver: local  # 로컬 디스크 사용

  # Board Service MySQL 데이터 볼륨 (완전 독립)
  board-mysql-data:
    driver: local

# ============================================
# 네트워크 정의: 컨테이너 간 통신
# ============================================
networks:
  # 커스텀 브릿지 네트워크 생성
  # 같은 네트워크의 컨테이너끼리 통신 가능
  msa-network:
    driver: bridge  # 브릿지 네트워크 드라이버
    # 나중에 Spring Boot 애플리케이션도 이 네트워크에 연결 가능
